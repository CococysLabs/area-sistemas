name: CI - Validaci√≥n de Contenido

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  validate-structure:
    name: Validar Estructura de Archivos
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Verificar archivos de seguridad
        run: |
          echo "üîç Verificando archivos de seguridad sensibles..."
          # Buscar solo archivos sensibles espec√≠ficos (Seguridad.txt/docx en ra√≠z de cursos)
          if find . -maxdepth 3 -type f \( -name "Seguridad.txt" -o -name "Seguridad.docx" -o -name "seguridad.txt" -o -name "seguridad.docx" \) | grep -q .; then
            echo "‚ùå ERROR: Se encontraron archivos de seguridad sensibles"
            find . -maxdepth 3 -type f \( -name "Seguridad.txt" -o -name "Seguridad.docx" -o -name "seguridad.txt" -o -name "seguridad.docx" \)
            exit 1
          fi
          echo "‚úÖ No se encontraron archivos de seguridad sensibles"
      
      - name: Validar que no hay videos
        run: |
          echo "üîç Verificando archivos de video..."
          if find . -type f \( -iname "*.mp4" -o -iname "*.avi" -o -iname "*.mov" -o -iname "*.mkv" -o -iname "*.flv" \) | grep -q .; then
            echo "‚ùå ERROR: Se encontraron archivos de video"
            find . -type f \( -iname "*.mp4" -o -iname "*.avi" -o -iname "*.mov" -o -iname "*.mkv" -o -iname "*.flv" \)
            exit 1
          fi
          echo "‚úÖ No se encontraron videos"
      
      - name: Validar estructura de carpetas
        run: |
          echo "üîç Verificando estructura de carpetas..."
          
          # Verificar que las carpetas de cursos tengan la estructura correcta
          for curso_dir in */; do
            # Ignorar carpetas especiales
            if [[ "$curso_dir" == ".github/" ]] || [[ "$curso_dir" == "2024-segundo-semestre/" ]]; then
              continue
            fi
            
            # Verificar que exista ciclo-1 o sea un curso v√°lido
            if [[ ! -d "${curso_dir}ciclo-1" ]] && [[ ! -f "${curso_dir}README.md" ]]; then
              echo "‚ö†Ô∏è  Advertencia: $curso_dir no tiene estructura est√°ndar"
            fi
          done
          echo "‚úÖ Estructura validada"
      
      - name: Verificar tama√±o de archivos
        run: |
          echo "üîç Verificando tama√±o de archivos..."
          
          # Buscar archivos mayores a 50MB
          large_files=$(find . -type f -size +50M 2>/dev/null || true)
          
          if [ ! -z "$large_files" ]; then
            echo "‚ö†Ô∏è  Advertencia: Archivos grandes encontrados (>50MB):"
            echo "$large_files" | while read file; do
              size=$(du -h "$file" | cut -f1)
              echo "  - $file ($size)"
            done
          else
            echo "‚úÖ No hay archivos excesivamente grandes"
          fi
      
      - name: Validar README.md en cursos
        run: |
          echo "üîç Verificando README.md en cada curso..."
          missing_readme=0
          
          for curso_dir in */ciclo-1; do
            curso=$(dirname "$curso_dir")
            if [[ ! -f "${curso}/README.md" ]]; then
              echo "‚ö†Ô∏è  Falta README.md en: $curso"
              missing_readme=$((missing_readme + 1))
            fi
          done
          
          if [ $missing_readme -gt 0 ]; then
            echo "‚ö†Ô∏è  $missing_readme cursos sin README.md"
          else
            echo "‚úÖ Todos los cursos tienen README.md"
          fi

  lint-markdown:
    name: Validar Markdown
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Instalar markdownlint
        run: npm install -g markdownlint-cli
      
      - name: Validar archivos Markdown
        run: |
          echo "üîç Validando archivos Markdown..."
          markdownlint '**/*.md' --ignore node_modules --config .markdownlint.json || true
          echo "‚úÖ Validaci√≥n de Markdown completada"

  security-scan:
    name: Escaneo de Seguridad
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Buscar credenciales o tokens
        run: |
          echo "üîç Buscando posibles credenciales expuestas..."
          
          # Buscar patrones comunes de credenciales
          if grep -r -i -E "(password|passwd|pwd|token|api_key|apikey|secret|credential).*[=:].*['\"][a-zA-Z0-9]{8,}" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null | grep -v ".github/workflows"; then
            echo "‚ö†Ô∏è  ADVERTENCIA: Se encontraron posibles credenciales en el c√≥digo"
            exit 1
          fi
          echo "‚úÖ No se encontraron credenciales expuestas"

  notify-reviewers:
    name: Notificar a Revisores
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Comentar en PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîç Validaci√≥n Autom√°tica

              ‚úÖ Las validaciones autom√°ticas han pasado exitosamente.
              
              **Pr√≥ximos pasos:**
              - Un revisor debe aprobar estos cambios
              - Verificar que el contenido cumple con los est√°ndares de COCOCYS
              - Confirmar que no hay informaci√≥n sensible
              
              @${context.payload.pull_request.user.login} - Tu contribuci√≥n est√° lista para revisi√≥n. ¬°Gracias! üéâ`
            })
